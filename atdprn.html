<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>atdprn</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/semantic-ui/2.1.8/semantic.min.css">
  <link rel="stylesheet" href="http://daigofuji.github.io/bbclub-font/css/bbclub-font.css">
  <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.2.1/mustache.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/semantic-ui/2.1.8/semantic.min.js"></script> -->
  <script src="http://stevenlevithan.com/assets/misc/date.format.js"></script>
</head>
<body>
<div class="ui vertical center aligned container">
  <h1 class="ui center aligned header">Are the Dodgers playing right now?</h1>
  <div id="playing-now">good question, checking...</div>

  <script id="playing-now-template-no" type="x-tmpl-mustache">
    <h2 id="playing-now-status">{{ playing_now }}</h2>
    <i>{{ no_but }}</i>
  </script>

  <script id="playing-now-template-yes" type="x-tmpl-mustache">
    <h2 id="playing-now-status">{{ playing_now }}</h2>
    <div class="ui stackable two column very relaxed grid container" style="position:relative;">
      <div class="column">
        <div class="ui segment">
          <h1><i class="bb-{{ away_name_abbrev }} bb-5x"></i></h1>
          <div>{{ away_score }}</div>
        </div>
      </div>
      <div class="ui vertical divider">@</div>
      <div class="column">
        <div class="ui segment">
          <h1><i class="bb-{{ home_name_abbrev }} bb-5x"></i></h1>
          <div>{{ home_score }}</div>`
        </div>
      </div>
    </div>
  </script>

</div>
<div class="ui hidden divider"></div>
<div class="ui vertical center aligned container">
  <h2 class="ui center aligned header">Today's Games:</h2>
  <div id="other-games" class="ui four doubling cards">
    Loading games...
  </div>
</div>

<script id="other-games-template" type="x-tmpl-mustache">
  {{ #game }}
    <div class="{{ color }} card">
      <div class="content">
        <div class="content">
          <div class="ui two column grid">
            <div class="column">
              <div><i class="bb-{{ away_name_abbrev }} bb-3x"></i></div>
              <div>{{ away_score }}</div>
            </div>
            <div class="column">
              <div><i class="bb-{{ home_name_abbrev }} bb-3x"></i></div>
              <div>{{ away_score }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="content"><i class="{{ inning_state }}"></i> {{ inning }}</div>
      <div class="extra content">
        <div>{{ status }}</div>
        <div>{{ event_time }} (EST)</div>
      </div>
    </div>
  {{ /game }}
</script>

<script type="text/javascript">
  var now = new Date();
  var year = now.getFullYear();
  var month = now.format("mm");
  var day = now.format("dd");
  var yesterday = parseInt(day, 10);
  yesterday--;

  // mustashe templates
  // game now status
  var playing_now_template_no = $('#playing-now-template-no').html();
  Mustache.parse(playing_now_template_no);
  var playing_now_template_yes = $('#playing-now-template-yes').html();
  Mustache.parse(playing_now_template_yes);
  // other games
  var other_games_template = $('#other-games-template').html();
  Mustache.parse(other_games_template);

  // get info about today's games
  $.getJSON("http://gd2.mlb.com/components/game/mlb/year_"+ year +"/month_"+ month +"/day_"+ day +"/grid.json", function(grid) {
    // console.log("grid:", grid);
    // find Dodger game
    grid.data.games.game.forEach(function(game) {
      // console.log("game:", game);
      // console.log("game status:", game.status);
      if (game.away_team_name === "Dodgers" || game.home_team_name === "Dodgers") {
        // console.log("game:", game);
        // add a little Dodger blue
        game.color = "blue";
        if (game.status === "In Progress") {
          // set answer to "Yes."
          game.playing_now = "Yes.";
          // render playing now template real quick
          var playing_now = Mustache.render(playing_now_template_yes, game);
          $('#playing-now').html(playing_now);
        } else {
          // console.log("game:", game);
          // console.log("game status:", game.status);
          // set answer to "No."
          game.playing_now = "No.";      
          game.no_but = "But don't worry, there's always beer.";
          // render playing now template real quick
          var playing_now = Mustache.render(playing_now_template_no, game);
          $('#playing-now').html(playing_now);
          // console.log("gid:", game.id);
          var gid = "gid_"+ game.id.split(/\/|-/).join('_');
          // console.log("gid:", gid);
          // get today's Dodger game details
          $.getJSON("http://gd2.mlb.com/components/game/mlb/year_"+ year +"/month_"+ month +"/day_"+ day +"/"+ gid +"/linescore.json", function(linescore) {
            // console.log("linescore:", linescore);
            $('#game-location').text(linescore.data.game.location);
            $('#game-time').text(linescore.data.game.home_time + linescore.data.game.home_ampm +" "+ linescore.data.game.home_time_zone);
            // get yesterday's result
            // $.getJSON("http://gd2.mlb.com/components/game/mlb/year_"+ year +"/month_"+ month +"/day_"+ yesterday +"/grid.json", function(grid_yesterday) {
            //   // console.log("grid_yesterday:", grid_yesterday);
            //   grid_yesterday.data.games.game.forEach(function(game_yesterday) {
            //     if (game_yesterday.away_team_name === "Dodgers" || game_yesterday.home_team_name === "Dodgers") {
            //       var gid_yesterday = "gid_"+ game_yesterday.id.split(/\/|-/).join('_');
            //       // console.log("gid_yesterday:", gid_yesterday);
            //       $.getJSON("http://gd2.mlb.com/components/game/mlb/year_"+ year +"/month_"+ month +"/day_"+ yesterday +"/"+ gid_yesterday +"/linescore.json", function(yesterday_linescore) {
            //         // console.log("yesterday_linescore:", yesterday_linescore);
            //         $('#yesterday-score-away').text(yesterday_linescore.data.game.away_team_runs);
            //         $('#yesterday-score-home').text(yesterday_linescore.data.game.home_team_runs);
            //         $('#yesterday-game-opponent').text(yesterday_linescore.data.game.away_team_city +", "+ yesterday_linescore.data.game.away_team_name);
            //       });
            //     }
            //   });
            // });
          });
        }
      }
      // get inning state
      if (game.top_inning === "Y") {
        game.inning_state = "caret up icon";
      } else if (game.top_inning === "N") {
        game.inning_state = "caret down icon";
      }
    });
    // render moustache template for games
    var other_games = Mustache.render(other_games_template, grid.data.games);
    $('#other-games').html(other_games);
  });
</script>
<style>
  .last.container {
    margin-bottom: 300px !important;
  }
  h1.ui.center.header {
    margin-top: 2em;
  }
  h2.ui.center.header {
    margin: 1em 0em 2em;
  }
  h3.ui.center.header {
    margin-top: 2em;
    padding: 2em 0em;
  }
  /* doubling to quartering hack */
  @media only screen and (max-width: 991px) and (min-width: 768px)
  .ui.four.doubling.cards .card {
    width: calc(25% - 2em);
  }
</style>
</body>
</html>